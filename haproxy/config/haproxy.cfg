global
    log stdout local0
    log stdout local1 notice
    maxconn 4096
    daemon
    # SSL/TLS configuration
    ssl-default-bind-ciphers ECDHE-RSA-AES128-GCM-SHA256:ECDHE-RSA-AES256-GCM-SHA384
    ssl-default-bind-options ssl-min-ver TLSv1.2 no-tls-tickets

defaults
    log     global
    mode    http
    option  httplog
    option  http-server-close
    timeout connect 5000ms
    timeout client  50000ms
    timeout server  50000ms

# Frontend: Listen on HTTPS for all incoming connections
frontend https_in
    # Bind to port 443 with SSL certificate
    bind 0.0.0.0:443 ssl crt /Users/jarismar/workspace/stocks-wallet-platform/haproxy/ssl/haproxy.pem

    mode http
    option httplog

    # Set the hostname to match requests
    acl is_stocks_wallet hdr(host) -i stocks-wallet-dev.jaristra.com

    # Path-based ACLs for backend routing
    acl path_public path_beg /sw/public/
    acl path_auth path_beg /sw/auth/
    acl path_api path_beg /sw/api/
    acl path_sw path_beg /sw/

    # Route to appropriate backend based on path
    use_backend public_backend if path_public
    use_backend auth_backend if path_auth
    use_backend api_backend if path_api
    use_backend sw_backend if path_sw

    # Default backend (404 response)
    default_backend default_404

# Backend 1: Public service on port 3000
backend public_backend
    mode http
    balance roundrobin
    server public_1 0.0.0.0:3000 check inter 5000 rise 2 fall 2

# Backend 2: Auth service on port 4000
backend auth_backend
    mode http
    balance roundrobin
    server auth_1 0.0.0.0:4000 check inter 5000 rise 2 fall 2

# Backend 3: API service on port 4001
backend api_backend
    mode http
    balance roundrobin
    server api_1 0.0.0.0:4001 check inter 5000 rise 2 fall 2

# Backend 4: Main service on port 3001
backend sw_backend
    mode http
    balance roundrobin
    server sw_1 0.0.0.0:3001 check inter 5000 rise 2 fall 2

# Backend: Default 404 response
backend default_404
    mode http
    # Custom error page for 404
    errorfile 400 /dev/null
    errorfile 403 /dev/null
    errorfile 408 /dev/null
    errorfile 500 /dev/null
    errorfile 502 /dev/null
    errorfile 503 /dev/null
    errorfile 504 /dev/null
    # Return 404 for all requests
    http-request deny deny_status 404

# Stats Dashboard
frontend stats_in
    bind 0.0.0.0:8404
    mode http
    stats enable
    stats uri /stats
    stats refresh 30s
    stats show-legends
    stats show-node
    stats admin if TRUE

listen stats
    bind 0.0.0.0:8404
    mode http
    stats enable
    stats uri /stats
    stats refresh 30s
    stats show-legends
    stats show-node
